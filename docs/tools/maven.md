> 2019-10-04 关于maven的简介。来自[w3cschool](https://www.w3cschool.cn/maven/)。资料可能有点老，部分内容结合了官方文档。不过，这篇教程，本身质量不太好，起码是不太适合完全新手。

- [简介](#%e7%ae%80%e4%bb%8b)
  - [安装](#%e5%ae%89%e8%a3%85)
  - [仓库](#%e4%bb%93%e5%ba%93)
- [POM](#pom)
  - [生命周期](#%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f)
  - [环境配置](#%e7%8e%af%e5%a2%83%e9%85%8d%e7%bd%ae)
  - [语法TODO](#%e8%af%ad%e6%b3%95todo)
- [命令](#%e5%91%bd%e4%bb%a4)
  - [创建工程](#%e5%88%9b%e5%bb%ba%e5%b7%a5%e7%a8%8b)
  - [构建工程](#%e6%9e%84%e5%bb%ba%e5%b7%a5%e7%a8%8b)
- [插件](#%e6%8f%92%e4%bb%b6)

# 简介

Maven 是一个项目管理和整合工具。
Maven 的主要目的是为开发者提供一个可复用、可维护、更易理解的工程综合模型、与这个模型交互的插件或者工具。

Maven 能够帮助开发者完成以下工作：构建、文档生成、报告、依赖、SCMs、发布、分发、邮件列表。

Maven 使用约定而不是配置。Maven 为工程提供了合理的默认行为。当创建 Maven 工程时，Maven 会创建默认的标准工程结构。开发者只需要合理的放置文件，而在 pom.xml 中不再需要定义任何配置。
例如：
- source code `${basedir}/src/main/java`
- resources `${basedir}/src/main/resources`
- Tests `${basedir}/src/test`
- Complied byte code `${basedir}/target`
- distributable JAR `${basedir}/target/classes`

## 安装

安装Java是前提，需要设置好 JAVA_HOME 。

```bash
wget http://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.2/binaries/apache-maven-3.6.2-bin.tar.gz
tar xzvf apache-maven-3.6.2-bin.tar.gz

export PATH=/path/to/apache-maven-3.6.2:$PATH

mvn -v
```

## 仓库

仓库是一个位置（place），可以存储所有的工程 jar 文件、library jar 文件、插件或任何其他的工程指定的文件。

Maven 仓库有三种类型：本地（local）、中央（central）、远程（remote）。
- Maven 本地仓库保存工程的所有依赖（library jar、plugin jar 等）。第一次运行 maven时，会自动下载所有依赖的 jar 文件到该仓库。本地仓库的位置一般是 `$HOME/.m2`
- Maven 中央仓库是由 Maven 社区提供的仓库，其中包含了大量常用的库。
- 远程仓库是开发人员自定义的仓库，包含了工程会用到的、但不在中央仓库中的 jar 文件。

除了这三种仓库可以作为依赖包的来源外，还有外部依赖，就是在 dependency 中指定 systemPath 和 scope 。

# POM

POM 代表工程对象模型。它是使用 Maven 工作时的基本组件，是一个 xml 文件。它被放在工程根目录下，文件命名为 pom.xml。每个工程只有1个POM文件。

**POM 包含了关于工程和各种配置细节的信息，Maven 使用这些信息构建工程。**

POM 也包含了目标和插件。当执行一个任务或者目标时，Maven 会查找当前目录下的 POM，从其中读取所需要的配置信息，然后执行目标。能够在 POM 中设置的一些配置如下：project dependencies， plugins， goals， build profiles， project version， developers， mailing list 。

**POM 文件需要 project 元素和三个必须的字段：groupId, artifactId,version。**
在仓库中的工程标识为 groupId:artifactId:version

所有POM都继承自一个父 POM（也称 super POM）。Maven 使用 effecitve-pom (super POM加上工程的配置)来执行相关的目标。
查看 super POM 默认配置的方法是：`mvn help:effective-pom`。

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!-- ====================================================================== -->
<!--                                                                        -->
<!-- Generated by Maven Help Plugin on 2019-10-05T08:38:31+08:00            -->
<!-- See: http://maven.apache.org/plugins/maven-help-plugin/                -->
<!--                                                                        -->
<!-- ====================================================================== -->
<!-- ====================================================================== -->
<!--                                                                        -->
<!-- Effective POM for project 'com.iceman.test:testMaven:jar:1.0-SNAPSHOT' -->
<!--                                                                        -->
<!-- ====================================================================== -->
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>
  <groupId>com.iceman.test</groupId>
  <artifactId>testMaven</artifactId>
  <version>1.0-SNAPSHOT</version>
  <name>testMaven</name>
  <url>http://www.example.com</url>
  <properties>
    <maven.compiler.source>1.7</maven.compiler.source>
    <maven.compiler.target>1.7</maven.compiler.target>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
  </properties>
  <dependencies>
    <dependency>
      <groupId>junit</groupId>
      <artifactId>junit</artifactId>
      <version>4.11</version>
      <scope>test</scope>
    </dependency>
  </dependencies>
  <repositories>
    <repository>
      <snapshots>
        <enabled>false</enabled>
      </snapshots>
      <id>central</id>
      <name>Central Repository</name>
      <url>https://repo.maven.apache.org/maven2</url>
    </repository>
  </repositories>
  <pluginRepositories>
    <pluginRepository>
      <releases>
        <updatePolicy>never</updatePolicy>
      </releases>
      <snapshots>
        <enabled>false</enabled>
      </snapshots>
      <id>central</id>
      <name>Central Repository</name>
      <url>https://repo.maven.apache.org/maven2</url>
    </pluginRepository>
  </pluginRepositories>
  <build>
    <sourceDirectory>/home/pm/Workshop/java-workshop/maven-proj/testMaven/src/main/java</sourceDirectory>
    <scriptSourceDirectory>/home/pm/Workshop/java-workshop/maven-proj/testMaven/src/main/scripts</scriptSourceDirectory>
    <testSourceDirectory>/home/pm/Workshop/java-workshop/maven-proj/testMaven/src/test/java</testSourceDirectory>
    <outputDirectory>/home/pm/Workshop/java-workshop/maven-proj/testMaven/target/classes</outputDirectory>
    <testOutputDirectory>/home/pm/Workshop/java-workshop/maven-proj/testMaven/target/test-classes</testOutputDirectory>
    <resources>
      <resource>
        <directory>/home/pm/Workshop/java-workshop/maven-proj/testMaven/src/main/resources</directory>
      </resource>
    </resources>
    <testResources>
      <testResource>
        <directory>/home/pm/Workshop/java-workshop/maven-proj/testMaven/src/test/resources</directory>
      </testResource>
    </testResources>
    <directory>/home/pm/Workshop/java-workshop/maven-proj/testMaven/target</directory>
    <finalName>testMaven-1.0-SNAPSHOT</finalName>
    <pluginManagement>
      <plugins>
        <plugin>
          <artifactId>maven-antrun-plugin</artifactId>
          <version>1.3</version>
        </plugin>
        <plugin>
          <artifactId>maven-assembly-plugin</artifactId>
          <version>2.2-beta-5</version>
        </plugin>
        <plugin>
          <artifactId>maven-dependency-plugin</artifactId>
          <version>2.8</version>
        </plugin>
        <plugin>
          <artifactId>maven-release-plugin</artifactId>
          <version>2.5.3</version>
        </plugin>
        <plugin>
          <artifactId>maven-clean-plugin</artifactId>
          <version>3.1.0</version>
        </plugin>
        <plugin>
          <artifactId>maven-resources-plugin</artifactId>
          <version>3.0.2</version>
        </plugin>
        <plugin>
          <artifactId>maven-compiler-plugin</artifactId>
          <version>3.8.0</version>
        </plugin>
        <plugin>
          <artifactId>maven-surefire-plugin</artifactId>
          <version>2.22.1</version>
        </plugin>
        <plugin>
          <artifactId>maven-jar-plugin</artifactId>
          <version>3.0.2</version>
        </plugin>
        <plugin>
          <artifactId>maven-install-plugin</artifactId>
          <version>2.5.2</version>
        </plugin>
        <plugin>
          <artifactId>maven-deploy-plugin</artifactId>
          <version>2.8.2</version>
        </plugin>
        <plugin>
          <artifactId>maven-site-plugin</artifactId>
          <version>3.7.1</version>
        </plugin>
        <plugin>
          <artifactId>maven-project-info-reports-plugin</artifactId>
          <version>3.0.0</version>
        </plugin>
      </plugins>
    </pluginManagement>
    <plugins>
      <plugin>
        <artifactId>maven-clean-plugin</artifactId>
        <version>3.1.0</version>
        <executions>
          <execution>
            <id>default-clean</id>
            <phase>clean</phase>
            <goals>
              <goal>clean</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <artifactId>maven-resources-plugin</artifactId>
        <version>3.0.2</version>
        <executions>
          <execution>
            <id>default-testResources</id>
            <phase>process-test-resources</phase>
            <goals>
              <goal>testResources</goal>
            </goals>
          </execution>
          <execution>
            <id>default-resources</id>
            <phase>process-resources</phase>
            <goals>
              <goal>resources</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <artifactId>maven-jar-plugin</artifactId>
        <version>3.0.2</version>
        <executions>
          <execution>
            <id>default-jar</id>
            <phase>package</phase>
            <goals>
              <goal>jar</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <artifactId>maven-compiler-plugin</artifactId>
        <version>3.8.0</version>
        <executions>
          <execution>
            <id>default-compile</id>
            <phase>compile</phase>
            <goals>
              <goal>compile</goal>
            </goals>
          </execution>
          <execution>
            <id>default-testCompile</id>
            <phase>test-compile</phase>
            <goals>
              <goal>testCompile</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <artifactId>maven-surefire-plugin</artifactId>
        <version>2.22.1</version>
        <executions>
          <execution>
            <id>default-test</id>
            <phase>test</phase>
            <goals>
              <goal>test</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <artifactId>maven-install-plugin</artifactId>
        <version>2.5.2</version>
        <executions>
          <execution>
            <id>default-install</id>
            <phase>install</phase>
            <goals>
              <goal>install</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <artifactId>maven-deploy-plugin</artifactId>
        <version>2.8.2</version>
        <executions>
          <execution>
            <id>default-deploy</id>
            <phase>deploy</phase>
            <goals>
              <goal>deploy</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <artifactId>maven-site-plugin</artifactId>
        <version>3.7.1</version>
        <executions>
          <execution>
            <id>default-site</id>
            <phase>site</phase>
            <goals>
              <goal>site</goal>
            </goals>
            <configuration>
              <outputDirectory>/home/pm/Workshop/java-workshop/maven-proj/testMaven/target/site</outputDirectory>
              <reportPlugins>
                <reportPlugin>
                  <groupId>org.apache.maven.plugins</groupId>
                  <artifactId>maven-project-info-reports-plugin</artifactId>
                </reportPlugin>
              </reportPlugins>
            </configuration>
          </execution>
          <execution>
            <id>default-deploy</id>
            <phase>site-deploy</phase>
            <goals>
              <goal>deploy</goal>
            </goals>
            <configuration>
              <outputDirectory>/home/pm/Workshop/java-workshop/maven-proj/testMaven/target/site</outputDirectory>
              <reportPlugins>
                <reportPlugin>
                  <groupId>org.apache.maven.plugins</groupId>
                  <artifactId>maven-project-info-reports-plugin</artifactId>
                </reportPlugin>
              </reportPlugins>
            </configuration>
          </execution>
        </executions>
        <configuration>
          <outputDirectory>/home/pm/Workshop/java-workshop/maven-proj/testMaven/target/site</outputDirectory>
          <reportPlugins>
            <reportPlugin>
              <groupId>org.apache.maven.plugins</groupId>
              <artifactId>maven-project-info-reports-plugin</artifactId>
            </reportPlugin>
          </reportPlugins>
        </configuration>
      </plugin>
    </plugins>
  </build>
  <reporting>
    <outputDirectory>/home/pm/Workshop/java-workshop/maven-proj/testMaven/target/site</outputDirectory>
  </reporting>
</project>
```

## 生命周期

生命周期是一组阶段的序列。

**Maven有3种标准的生命周期：clean（清理）、build（构建）、site（报告）。**  
**clean生命周期的阶段包括：pre-clean、clean、post-clean。**  
**site生命周期的阶段包括：pre-site、site、post-site、site-deploy。**  
**build生命周期的阶段包括**：
| 生命周期阶段 | 描述 |
|------------|------|
| **validate** | 检查配置是否正确，完成构建过程的所有必要信息是否能够获取到。 |
| initialize | 初始化构建状态，例如设置属性。 |
| generate-sources | 生成编译阶段需要包含的任何源码文件。 |
| process-sources | 处理源代码，例如，过滤任何值（filter any value）。 |
| generate-resources | 生成工程包中需要包含的资源文件。 |
| process-resources | 拷贝和处理资源文件到目的目录中，为打包阶段做准备。 |
| **compile** | 编译工程源码。 |
| process-classes | 处理编译生成的文件，例如 Java Class 字节码的加强和优化。 |
| generate-test-sources | 生成编译阶段需要包含的任何测试源代码。 |
| process-test-sources | 处理测试源代码，例如，过滤任何值。 |
| test-compile | 编译测试源代码到测试目的目录。 |
| process-test-classes | 处理测试代码文件编译后生成的文件。 |
| **test** | 使用适当的单元测试框架（例如JUnit）运行测试。 |
| prepare-package | 在真正打包之前，为准备打包执行任何必要的操作。 |
| **package** | 获取编译后的代码，并打包成可发布的格式，例如 JAR、WAR 。 |
| pre-integration-test | 在集成测试执行之前，执行所需的操作。例如设置环境变量。 |
| integration-test | 处理和部署必须的工程包到集成测试能够运行的环境中。 |
| post-integration-test | 在集成测试被执行后执行必要的操作。例如，清理环境。 |
| **verify** | 运行检查操作来验证工程包是有效的，并满足质量要求。 |
| **install** | 安装工程包到本地仓库中，该仓库可以作为本地其他工程的依赖。 |
| **deploy** | 拷贝最终的工程包到远程仓库中，以共享给其他开发人员和工程。 |

如果不明确指定，一个典型的Maven构建过程包括：process-resource（资源拷贝）、compile（编译）、package（打包）、install（安装工程包）。


在 POM 中可以配置 `<phase>` / `<goals>`，指定在某个特定生命周期阶段完成某个目标，每个目标都有关联的 tasks 。具体参见 pom 语法部分。
示例中的代码结构为（重点是使用了 maven-antrun-plugin，指定了 executions-execution-configuration-tasks的任务）：
```xml
<project>
    <build>
        <plugins>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-antrun-plugin</artifactId>
                <version>1.1</version>
                <executions>
                    <execution>
                        <id>id.pre-clean</id>
                        <phase>pre-clean</phase>
                        <goals>
                            <goal>run</goal>
                        </goals>
                        <configuration>
                            <tasks>...</tasks>
                        </configuration>
                    </execution>
                    <execution>...</execution>
                </executions>
            </plugin>
        </plugins>
    </build>
</project>
```

## 环境配置

构建一组配置，用于根据不同的环境定制不同的构建过程，如 Production 和 Development 。
环境配置在 pom.xml 中使用 `<activeProfiles>` / `<profiles>` 指定。

可以使用命令行参数、环境变量等方式激活相应的配置。

> iceman注：由于不太熟悉 plugin 的使用和配置文件的组件，以下环境配置实例的内容仅是猜测。

（通过 archetype 创建的项目）默认的 pom.xml 在 project 根元素下，除了 groupId/artifactId/version/name/url 等项目属性外，还有 dependencies、build 两个元素。
```xml
<project>
    <dependencies>
        <dependency>...</dependency>
        <dependency>...</dependency>
    </dependencies>
    <build>
        <pluginManagement>
            <plugins>
                <plugin>...</plugin>
                <plugin>...</plugin>
            <plugins>
        </pluginManagement>
    </build>
</project>
```
示例的环境配置后的 pom.xml，在 project 根元素下，除了 groupId/artifactId/version等项目属性外，只有一个 profiles 元素，其下有多个 profile 元素：dependencies、build等元素被放置在 profile 元素之下；还有id等profile的属性。
使用时，可以通过 `-P` 指定使用的配置。
```xml
<project>
    <profiles>
        <profile></profile>
            <id>...</id>
            <build>
                ...
            </build>
    </profiles>
</project>
```

示例将配置保存为单独的文件，在 pom-profiles-profile 中，借助 maven-antrun-plugin 的 tasks 使用了 copy file 指令，将单独的配置引入 pom.xml 。


## 语法TODO

# 命令

## 创建工程

Maven 使用原型（archetype）插件创建工程。借助 maven-archetype-quickstart 插件，可以创建若干种不同的工程：`mvn archetype:generate` 。创建过程通过交互式方式完成。

一个HelloWorld工程，包括：src/java/main、src/java/test、pom.xml 。构建过程中还会生成 target/classes、target/site 等目录。

如果是创建webapp，只需指定 archetype 为 maven-archetype-webapp 。（应该是交互模式的第一个问题。）

## 构建工程

当通过 `mvn xx-phase` 调用构建生命周期的某个阶段时，该阶段之前的所有阶段都会被执行。（参见[构建生命周期](#%e6%9e%84%e5%bb%ba%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f)。）

`mvn clean package` 将会清理之前的构建文件并重新打包。打包的文件保存在 target/xxx-x.x-SNAPSHOT.jar 。

# 插件

Maven 实际上是一个依赖插件执行的框架，每个任务实际上是由插件完成。

插件通常提供了一个目标的集合，并且可以使用下面的语法执行：`mvn [plugin-name]:[goal-name]`。例如：使用 maven-compiler-plugin 的 compile-goal 编译的命令是：`mvn compiler:compile`。

Maven提供两种类型的插件：Build plugins（用于build）、Reporting plugins（用于site）。

常用的插件包括：
- clean：构建之后清理目标文件。删除目标目录。
- compiler：编译 Java 源文件。
- surefile：运行 JUnit 单元测试。创建测试报告。
- jar：从当前工程中构建 JAR 文件。
- war：从当前工程中构建 WAR 文件。
- javadoc：为工程生成 Javadoc。
- antrun：从构建过程的任意一个阶段中运行一个 ant 任务的集合。

